---
- hosts: galaxie
  user: zoe
  sudo: true
#         - { key: "ListenAddress",   value: "{{ansible_default_ipv4.address}}" }
  tasks:
    - name: sshd is configured the galaxie way
      lineinfile:
        dest=/etc/ssh/sshd_config
        regexp="^{{ item.key }} "
        line="{{ item.key }} {{ item.value }}"
        insertafter="{{ item.key }} "
        state=present
        backup=yes
        validate="/usr/sbin/sshd -T -f %s"
      with_items:
        - { key: "ListenAddress",   value: "0.0.0.0" }
        - { key: "Protocol",        value: "2" }
        - { key: "DebianBanner",    value: "no" }
        - { key: "PrintLastLog",    value: "yes" }
        - { key: "SyslogFacility",  value: "AUTH" }
        - { key: "LogLevel",        value: "INFO" }
        - { key: "LoginGraceTime",  value: "60" }
        - { key: "StrictModes",     value: "yes" }
        - { key: "TCPKeepAlive",    value: "yes" }
        - { key: "Compression ",     value: "yes" }
        - { key: "IgnoreRhosts",    value: "yes" }
        - { key: "PermitRootLogin",     value: "no" }
        - { key: "RSAAuthentication",   value: "no" }
        - { key: "ClientAliveInterval", value: "120" }
        - { key: "ClientAliveCountMax", value: "600" }
        - { key: "PubkeyAuthentication",  value: "yes" }
        - { key: "AuthorizedKeysFile",    value: "%h/.ssh/authorized_keys" }
        - { key: "RhostsRSAAuthentication", value: "no" }
        - { key: "HostbasedAuthentication", value: "no" }
        - { key: "PermitEmptyPasswords",    value: "no" }
        - { key: "PasswordAuthentication",  value: "no" }
        - { key: "GSSAPIAuthentication",    value: "no" }
        - { key: "ChallengeResponseAuthentication", value: "no" }
      notify:
        - restart sshd

    - name: ssh is configured the galaxie way
      lineinfile:
        dest=/etc/ssh/ssh_config
        regexp="^{{ item.key }} "
        line="{{ item.key }} {{ item.value }}"
        state=present
        backup=yes
      with_items:
        - { key: "CompressionLevel", value: "9" }
      notify:
        - restart sshd

    - name: disable check local mail after login
      lineinfile:
        dest=/etc/pam.d/sshd
        backrefs=yes
        state=present
        regexp="^session    optional     pam_mail.so standard noenv"
        line="#session    optional     pam_mail.so standard noenv \\# [1]"

  handlers:
    - name: restart sshd
      service:
        name=ssh
        state=restarted
