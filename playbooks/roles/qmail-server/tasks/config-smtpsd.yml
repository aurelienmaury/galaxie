---
# Configure services to start
- name: creat "{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}" service directories
  file:
    path="{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}"
    state=directory
    owner=root
    group=root
    mode=1755
  tags: supervise

- name: set statup script "{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/run"
  template:
    src=service-qmail-smtpsd-run.j2
    dest="{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/run"
    mode=0700
  tags: supervise

# Configure multilog service
- name: creat "{{ galaxie_qmail_server_multilog_dir }}/{{ galaxie_qmail_server_service_smtpsd }}" multilog directory
  file:
    path="{{ galaxie_qmail_server_multilog_dir }}/{{ galaxie_qmail_server_service_smtpsd }}"
    owner="{{ galaxie_qmail_server_qmaill_user }}"
    group=root
    state=directory
    mode=2755
  tags: multilog

- name: creat "{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/log" log directorie
  file:
    path="{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/log"
    state=directory
    owner=root
    group=root
    mode=0755
  tags: supervise

- name: set statup script "{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/log/run"
  template:
    src=service-qmail-smtpsd-log-run.j2
    dest="{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/log/run"
    mode=0700
  tags: supervise

# Configure Makefile
- name: send "{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/Makefile" file
  template:
    src=service-qmail-smtpsd-makefile.j2
    dest={{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/Makefile
    mode=0644
    owner=root
    group=root
  tags: supervise

- name: send "{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/tcp" file
  template:
    src=service-qmail-smtpsd-tcpdb.j2
    dest="{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/tcp"
    mode=0644
    owner=root
    group=root
  notify: rebuild qmail-smtpsd tcpdb
  tags: supervise

- name: creat {{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}/tcp.cdb
  shell: make
    chdir="{{ galaxie_qmail_server_supervise_dir }}/{{ galaxie_qmail_server_service_smtpsd }}"
  changed_when: false
  tags: supervise

# Openssl auto signed certificate
- name: delete "{{ galaxie_qmail_server_qmail_dir }}/control/servercert.pem"
  file:
    path={{ galaxie_qmail_server_qmail_dir }}/control/servercert.pem
    state=absent
  when: galaxie_qmail_server_openssl_key_gen
  tags: self-certificat

- name: auto signed rsa:{{ galaxie_qmail_server_openssl_key_bit }} key, valide for {{ galaxie_qmail_server_openssl_key_days }} days , to "{{ galaxie_qmail_server_qmail_dir }}/control/servercert.pem"
  shell:  openssl req -newkey rsa:{{ galaxie_qmail_server_openssl_key_bit }} -x509 -nodes -days {{ galaxie_qmail_server_openssl_key_days }} -out servercert.pem -keyout servercert.pem -subj "{{ galaxie_qmail_server_openssl_subj }}"
    chdir="{{ galaxie_qmail_server_qmail_dir }}/control"
    creates="{{ galaxie_qmail_server_qmail_dir }}/control/servercert.pem"
  tags: self-certificat

- name: check "{{ galaxie_qmail_server_qmail_dir }}/control/servercert.pem" permissions
  file:
    path="{{ galaxie_qmail_server_qmail_dir }}/control/servercert.pem"
    owner=root
    group={{ galaxie_qmail_server_qmail_group }}
    mode=0640
  tags: self-certificat