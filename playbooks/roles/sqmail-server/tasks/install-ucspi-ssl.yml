---
- name: install packages for ucspi-ssl building
  apt:
    pkg={{ item }}
    state=present
  with_items:
    - build-essential
    - libssl-dev
    - libperl-dev

- name: check {{ glx_slashpackage_dir }} directory
  file:
    path="{{ glx_slashpackage_dir }}"
    state=directory
    mode=1755

- name: check {{ glx_ucspi_ssl_source_dir }} directory
  file:
    path="{{ glx_ucspi_ssl_source_dir }}"
    state=directory

- name: delete "{{ glx_ucspi_ssl_source_dir }}/{{ glx_ucspi_ssl_source_name }}.{{ glx_ucspi_ssl_source_extension }}"
  file:
    path="{{ glx_ucspi_ssl_source_dir }}/{{ glx_ucspi_ssl_source_name }}.{{ glx_ucspi_ssl_source_extension }}"
    state=absent
  when: glx_ucspi_ssl_force_install

- name: get "{{ glx_ucspi_ssl_source_url }}"
  get_url:
    url="{{ glx_ucspi_ssl_source_url }}"
    dest={{ glx_ucspi_ssl_source_dir }}
    sha256sum=9f3bcf66546b433b089f6f340d243065beb801b97d4026e54dd586f0022b5f1e
  register: glx_ucspi_ssl_download

- name: delete "{{ glx_slashpackage_dir }}/host/superscript.com/net/ucspi-ssl-0.95b" directory
  file:
    path="{{ glx_slashpackage_dir }}/host/superscript.com/net/ucspi-ssl-0.95b"
    state=absent
  when: glx_ucspi_ssl_download.changed

- name: unarchive {{ glx_ucspi_ssl_download.dest }}
  unarchive:
    src="{{ glx_ucspi_ssl_download.dest }}"
    dest="{{ glx_slashpackage_dir }}"
    copy=no
  when: glx_ucspi_ssl_download.changed

- name: fixe permissions
  file:
    path="{{ glx_slashpackage_dir }}/host/superscript.com/net/ucspi-ssl-0.95b"
    owner="root"
    group="root"
    recurse=yes
  when: glx_ucspi_ssl_download.changed

- name: check "{{ glx_ucspi_ssl_certificates_dir }}" directory
  file:
    path="{{ glx_ucspi_ssl_certificates_dir }}"
    owner=root
    group=root
    state=directory
    mode=0755

- name: generate {{ glx_ucspi_ssl_dh_bits }} bits dh parameter "{{ glx_ucspi_ssl_dh_parameter_file }}" fle
  shell: openssl dhparam -out {{ glx_ucspi_ssl_dh_parameter_file }} {{ glx_ucspi_ssl_dh_bits }}
    creates=/etc/ssl/certs/dhparam.pem

- name: update src/conf-dhfile to reflect "{{ glx_ucspi_ssl_dh_parameter_file }}" DH parameter file.
  replace:
    dest="{{ glx_ucspi_ssl_conf_dhfile }}"
    regexp="^/usr/local/ssl/pem/dh1024.pem"
    replace="{{ glx_ucspi_ssl_dh_parameter_file }}"

- name: check src/conf-dhfile
  lineinfile:
    dest="{{ glx_ucspi_ssl_conf_dhfile }}"
    line="{{ glx_ucspi_ssl_dh_parameter_file }}"
    state=present

- name: update src/conf-cadir for point to "{{ glx_ucspi_ssl_certificates_dir }}".
  replace:
    dest="{{ glx_ucspi_ssl_conf_cadir }}"
    regexp="^/usr/local/ssl/certs"
    replace="{{ glx_ucspi_ssl_certificates_dir }}"

- name: check src/conf-cadir
  lineinfile:
    dest="{{ glx_ucspi_ssl_conf_cadir }}"
    line="{{ glx_ucspi_ssl_certificates_dir }}"
    state=present

- name: package/install
  shell: package/install
    chdir="{{ glx_slashpackage_dir }}/host/superscript.com/net/ucspi-ssl-0.95b"
  when: glx_ucspi_ssl_download.changed

- name: package/man
  shell: package/man
    chdir="{{ glx_slashpackage_dir }}/host/superscript.com/net/ucspi-ssl-0.95b"
  when: glx_ucspi_ssl_download.changed